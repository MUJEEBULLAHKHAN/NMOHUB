<div class="container mt-4">
  <h3>Virtual Request</h3>

  <div *ngIf="showLoader" class="text-center my-4">
    <div class="spinner-border" role="status"></div>
  </div>

  <div class="table-responsive">
    <table class="table table-striped table-bordered" *ngIf="!showLoader && virtualRequest.length > 0">
      <thead class="table-dark">
        <tr>
          <!-- <th>#</th> -->
          <!-- <th>Service ID</th> -->
          <th>Employee Name</th>
          <th>Name</th>
          <th>Created Date</th>
          <th>Price</th>
          <th>Access Room Qty</th>
          <th>Expiry Date</th>
          <th>Office Address</th>

          <th>Status</th>
          <th class="text-end">Action</th>
          <th class="text-end">View Slots</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let req of virtualRequest">
          <td>{{ req.firstNames }} </td>
          <td>{{ req.name }} </td>
          <td>{{ req.createdDate | date : "d/M/yyyy" }}</td>
          <td>
            {{ req.price}}
          </td>

          <td>{{ req.meetingAccessRoomQty}}</td>
          <td>{{ req.expiryDate | date : "d/M/yyyy"}}</td>
          <td>{{ req.officeAddress}}</td>

          <td>
            <span [class]="
                req.status === 'Submit'
                  ? 'badge bg-danger'
                  : 'badge bg-success'
              ">
              {{ req.status }}
            </span>
          </td>
          <td>
            <button *ngIf="req.status === 'Submit'" type="submit" class="btn btn-primary m-1"
              (click)="ApprovePackageRequestRequest(req.packageRequestId)">
              Accept

              <span role="status" aria-hidden="true" class="spinner-border spinner-border-sm align-middle"
                *ngIf="virtualSpaceLoader"></span>
            </button>

            <button *ngIf="req.status === 'Submit'" type="submit" class="btn btn-primary"
              (click)="RejectPackageRequestRequest(req.packageRequestId)">
              Reject

              <span role="status" aria-hidden="true" class="spinner-border spinner-border-sm align-middle"
                *ngIf="virtualSpaceLoader"></span>
            </button>

            <button *ngIf="req.status === 'Approve' && roles[0].id != 10" type="submit" class="btn btn-primary m-1"
              (click)="openBookingModal(req, bookingModal)">
              Book Meeting Slot

              <span role="status" aria-hidden="true" class="spinner-border spinner-border-sm align-middle"
                *ngIf="virtualSpaceLoader"></span>
            </button>

          </td>

          <td>
            <button type="submit" class="btn btn-primary m-1"
              (click)="openMeetingScheduleModal(req, meetingSlotModal)">
              View

              <span role="status" aria-hidden="true" class="spinner-border spinner-border-sm align-middle"
                *ngIf="virtualSpaceLoader"></span>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div *ngIf="!showLoader && virtualRequest.length === 0" class="alert alert-warning">
    No Meeting Access Requests found.
  </div>
</div>




<ng-template #bookingModal let-modal style="z-index: 1500 !important">
  <div class="modal-header">
    <h5 class="modal-title">Book Meeting Room</h5>
    <button type="button" class="btn-close" aria-label="Close"
      (click)="modal.dismiss(); bookingForm.reset(); selectedSlot = null"></button>
  </div>

  <form [formGroup]="bookingForm" (ngSubmit)="confirmBooking()">
    <div class="modal-body">

      <div class="alert alert-primary" *ngIf="selectedSlot">
        <strong>Selected Slot: {{meetingRoomNo}}</strong><br />
        Date: {{ selectedSlot.slotDate | date : "fullDate" }}<br />
        Time: {{ startTime }} -
        {{ endTime }}
      </div>
      <div class="calendar-container">
        <!-- Header with navigation -->
        <div class="calendar-header mb-3">
          <div class="d-flex justify-content-between align-items-center">
            <div class="nav-controls">
              <button type="button" class="btn btn-outline-primary btn-sm me-2"
                (click)="navigatePrevious(); $event.stopPropagation()" [disabled]="shouldDisableBackNavigation()">
                &#8249;
              </button>
              <button type="button" class="btn btn-outline-primary btn-sm me-2"
                (click)="navigateNext(); $event.stopPropagation()">
                &#8250;
              </button>
              <button type="button" class="btn btn-outline btn-sm" (click)="goToToday(); $event.stopPropagation()">
                Today
              </button>
            </div>

            <div class="date-range">
              <h5 class="mb-0">{{ getDateRangeDisplay() }}</h5>
            </div>

            <div class="view-controls">
              <button type="button" class="btn btn-primary btn-sm" [class.active]="currentView === 'week'"
                (click)="setView('week'); $event.stopPropagation()">
                Week
              </button>
            </div>
          </div>
        </div>

        <!-- Weekly Calendar View -->
        <div class="calendar-grid" *ngIf="currentView === 'week'">
          <!-- Day headers -->
          <div class="row day-headers mb-2">
            <div class="col-1 time-column"></div>
            <div class="col day-header text-center" *ngFor="let day of currentWeekDays">
              <div class="day-name fw-bold">{{ formatDayHeader(day) }}</div>
            </div>
          </div>

          <!-- Time slots and events -->
          <div class="time-grid">
            <div class="row time-row" *ngFor="let timeSlot of timeSlots">
              <div class="col-1 time-label text-end pe-2">
                <small class="text-muted">{{ timeSlot }}</small>
              </div>

              <div class="col day-cell position-relative" *ngFor="let day of currentWeekDays" [class.border]="true"
                [class.border-primary]="isSlotSelected(day, timeSlot)" [class.bg-light]="isSlotSelected(day, timeSlot)"
                [class.cursor-pointer]="isSlotOccupied(day, timeSlot)" style="min-height: 50px; cursor: pointer">
                <!-- Events for this time slot -->
                <div *ngFor="let event of getEventsForDayAndTime(day, timeSlot)" class="mb-1 w-100"
                  [class.bg-success]="event.type === 'green'" [class.text-white]="event.type === 'green'"
                  [class.bg-primary]="event.type === 'gray'" [class.text-white]="event.type === 'gray'">
                  <div class="event-content" (click)="selectTimeSlot(day, timeSlot, event)">

                    <!-- <small class="event-time d-block">
                  {{ event.startTime | date:'shortTime' }} - {{ event.endTime |
                  date:'shortTime' }}
                </small> -->
                    <small class="event-time d-block">
                      <!-- {{ event.startTime }} - {{ event.endTime }} -->
                      {{ formatTimeSlot(event.startTime) }} -
                      {{ formatTimeSlot(event.endTime) }}
                    </small>
                    <small class="event-title fw-bold">
                      <span *ngIf="event.status === 'Available'" class="text-white">
                        Available
                        <span *ngIf="event.isMeetingRoomOne"> Room 1 </span>
                        <span *ngIf="event.isMeetingRoomTwo"> Room 2 </span>
                      </span>
                      <span *ngIf="event.status === 'Booked'" class="text-white">
                        Booked
                      </span>
                    </small>
                  </div>
                </div>

                <!-- Selection indicator -->
                <div *ngIf="isSlotSelected(day, timeSlot)" class="position-absolute top-50 start-50 translate-middle">
                  <i class="fas fa-check-circle text-primary"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-outline" (click)="modal.dismiss(); bookingForm.reset();">
        Cancel
      </button>
      <button type="submit" class="btn btn-primary" [disabled]="bookingForm.invalid">
        Confirm

        <span role="status" aria-hidden="true" class="spinner-border spinner-border-sm align-middle"
          *ngIf="bookingLoader"></span>
      </button>

      <!-- <button *ngIf="isOTPSend" type="button" class="btn btn-primary" [disabled]="bookingForm.invalid"
          (click)="SendOtp('MeetingRoomAccess','')">
          Send OTP

          <span role="status" aria-hidden="true" class="spinner-border spinner-border-sm align-middle"
            *ngIf="bookingLoader"></span>
        </button> -->
    </div>
  </form>
</ng-template>


<ng-template #meetingSlotModal let-modal style="z-index: 1500 !important">
  <div class="modal-header">
    <h5 class="modal-title">Booking Slots</h5>
    <button type="button" class="btn-close" aria-label="Close"
      (click)="modal.dismiss(); bookingForm.reset(); selectedSlot = null"></button>
  </div>

  <form>
    <div class="modal-body">
      <div class="col-md-12" style="margin: 0px 10px;">
        <div class="card custom-card">
          <div class="card-body p-0">
            <div class="p-3">
              <div class="d-flex align-items-center justify-content-between">
                <h6 class="fw-medium">Activity :</h6>
                <!-- <button class="btn btn-primary-light btn-sm btn-wave waves-effect waves-light">
                            View All
                        </button> -->
              </div>
            </div>
            <div class="p-3 border-bottom simplebar-scrollable-y" id="full-calendar-activity" data-simplebar="init">
              <div class="simplebar-wrapper" style="margin: -16px">
                <div class="simplebar-height-auto-observer-wrapper">
                  <div class="simplebar-height-auto-observer"></div>
                </div>
                <div class="simplebar-mask">
                  <div class="simplebar-offset" style="right: 0px; bottom: 0px">
                    <div class="simplebar-content-wrapper" tabindex="0" role="region" aria-label="scrollable content"
                      style="height: auto; overflow: hidden scroll">
                      <div class="simplebar-content" style="padding: 16px">
                        <ul class="list-unstyled mb-0 fullcalendar-events-activity">
                          <li *ngFor="let item of filteredSlots; let i = index">
                            <div class="d-flex align-items-center justify-content-between flex-wrap">
                              <a href="javascript:void(0);">
                                <p class="mb-1 fw-medium">
                                  {{ item.date | date:'MMM dd, yyyy' }}
                                </p>

                                <p class="mb-1 fw-medium">
                                  From {{item.startTime}} To {{item.endTime}}
                                </p>

                              </a>
                            </div>
                            <p class="mb-0 text-muted fs-12">
                              <span *ngIf="item.status == 'Available'" style="color: green;font-weight: bold;">
                                {{item.status}}
                              </span>

                              <span *ngIf="item.status == 'Booked'" style="color: red;font-weight: bold;">
                                {{item.status}}
                              </span>
                            </p>
                          </li>

                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="simplebar-placeholder" style="width: 306px; height: 421px"></div>
              </div>
              <div class="simplebar-track simplebar-horizontal" style="visibility: hidden">
                <div class="simplebar-scrollbar" style="width: 0px; display: none"></div>
              </div>
              <div class="simplebar-track simplebar-vertical" style="visibility: visible">
                <div class="simplebar-scrollbar" style="
                  height: 348px;
                  transform: translate3d(0px, 0px, 0px);
                  display: block;
                "></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-outline" (click)="modal.dismiss(); bookingForm.reset();">
        Cancel
      </button>
    </div>
  </form>
</ng-template>